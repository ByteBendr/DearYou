<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <title>üíåDearYouüíå</title>
  <meta name="description" content="DearYou - A clean, professional messaging platform for anonymous communication. Send messages, build conversations, and connect authentically.">
  <meta name="keywords" content="professional messaging, anonymous messages, DearYou, secure messaging, communication platform">
  <meta property="og:title" content="DearYou - Professional Messaging">
  <meta property="og:description" content="Clean, professional anonymous messaging platform">
  <meta property="og:type" content="website">
  <meta name="theme-color" content="#2D3748">
  
  <style>
    :root {
      --primary: #2D3748;
      --primary-light: #4A5568;
      --accent: #4299E1;
      --accent-hover: #3182CE;
      --background: #F7FAFC;
      --surface: #FFFFFF;
      --border: #E2E8F0;
      --text-primary: #1A202C;
      --text-secondary: #718096;
      --text-muted: #A0AEC0;
      --success: #48BB78;
      --warning: #ECC94B;
      --danger: #F56565;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    
    .container {
      max-width: 680px;
      margin: 0 auto;
      background: var(--surface);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      background: var(--primary);
      color: white;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    
    .header-user {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .menu-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    /* Filter Panel */
    .filter-panel {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: none;
      flex-direction: column;
      gap: 10px;
      animation: slideDown 0.2s ease;
    }
    
    .filter-panel.active {
      display: flex;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .filter-row {
      display: flex;
      gap: 8px;
    }
    
    .filter-panel input,
    .filter-panel select {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--surface);
      color: var(--text-primary);
      outline: none;
      transition: all 0.2s;
    }
    
    .filter-panel input:focus,
    .filter-panel select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }
    
    .action-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .action-btn:active {
      transform: scale(0.98);
    }
    
    .action-btn.secondary {
      background: var(--background);
      color: var(--text-primary);
    }
    
    /* Messages Container */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: var(--background);
    }
    
    .messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    
    /* Message Card */
    .message-card {
      background: var(--surface);
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      animation: fadeInUp 0.3s ease;
      border: 1px solid var(--border);
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message-card.pinned {
      border-left: 3px solid var(--accent);
    }
    
    .message-header {
      padding: 12px 16px;
      background: var(--background);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    
    .message-meta {
      flex: 1;
      min-width: 0;
    }
    
    .message-names {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }
    
    .message-names .arrow {
      color: var(--text-muted);
      font-size: 11px;
    }
    
    .message-timestamp {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .message-tag {
      background: var(--accent);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .message-body {
      padding: 16px;
    }
    
    .message-content {
      font-size: 15px;
      color: var(--text-primary);
      line-height: 1.6;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .message-expires {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .message-actions {
      display: flex;
      padding: 8px 12px;
      border-top: 1px solid var(--border);
      gap: 4px;
    }
    
    .action-icon {
      background: none;
      border: none;
      color: var(--text-secondary);
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 6px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .action-icon:active {
      transform: scale(0.95);
      background: var(--background);
    }
    
    .action-icon.active {
      color: var(--accent);
    }
    
    .reaction-count {
      font-size: 12px;
      font-weight: 500;
    }
    
    /* Replies */
    .replies {
      margin: 0 16px 12px 16px;
      padding: 12px;
      background: var(--background);
      border-radius: 8px;
      border-left: 2px solid var(--border);
    }
    
    .reply-item {
      padding: 10px;
      background: var(--surface);
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .reply-item:last-child {
      margin-bottom: 0;
    }
    
    .reply-header {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .reply-content {
      color: var(--text-primary);
    }
    
    /* Compose */
    .compose {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 16px;
      position: sticky;
      bottom: 0;
      transition: transform 0.3s ease;
      z-index: 100;
    }
    
    .compose-toggle-wrapper {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 101;
      align-items: center;
      gap: 12px;
      transition: all 0.3s ease;
    }
    
    .compose-toggle {
      width: 56px;
      height: 56px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .compose-toggle:active {
      transform: scale(0.95);
    }
    
    .compose-label {
      background: var(--surface);
      color: var(--text-primary);
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      white-space: nowrap;
      animation: slideInRight 0.3s ease;
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .compose-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 98;
      backdrop-filter: blur(2px);
    }
    
    @media (max-width: 768px) {
      .compose-backdrop.active {
        display: block;
        animation: fadeIn 0.2s ease;
      }
      
      .compose-toggle-wrapper {
        display: flex;
      }
    }
    
    .compose-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .compose-header {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .compose-header button {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 13px;
      cursor: pointer;
      padding: 4px;
    }
    
    .compose-row {
      display: flex;
      gap: 8px;
    }
    
    .compose input,
    .compose textarea,
    .compose select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: var(--surface);
      color: var(--text-primary);
      outline: none;
      transition: all 0.2s;
    }
    
    .compose input:focus,
    .compose textarea:focus,
    .compose select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }
    
    .compose textarea {
      resize: none;
      min-height: 70px;
    }
    
    .compose-footer {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .expiry-group {
      display: flex;
      gap: 8px;
      flex: 1;
      align-items: center;
    }
    
    .expiry-group label {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    
    .expiry-group input[type="checkbox"] {
      width: auto;
    }
    
    .expiry-group input[type="number"] {
      width: 70px;
      padding: 8px;
    }
    
    .send-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .send-btn:active {
      transform: scale(0.98);
      background: var(--accent-hover);
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
      backdrop-filter: blur(4px);
    }
    
    .modal.active {
      display: flex;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background: var(--surface);
      padding: 32px 24px;
      border-radius: 16px;
      max-width: 400px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      animation: scaleIn 0.2s ease;
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .modal-content h2 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .modal-content p {
      color: var(--text-secondary);
      margin-bottom: 24px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .modal-content input {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
      margin-bottom: 20px;
      outline: none;
      transition: all 0.2s;
    }
    
    .modal-content input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }
    
    .modal-content button {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-content button:active {
      transform: scale(0.98);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    .empty-state p {
      font-size: 14px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .compose {
        transform: translateY(100%);
      }
      
      .compose.active {
        transform: translateY(0);
      }
      
      .compose-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .compose-toggle-wrapper.hidden {
        display: none !important;
      }
    }
    
    @media (max-width: 480px) {
      .header h1 {
        font-size: 18px;
      }
      
      .header-user {
        font-size: 12px;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .compose-footer {
        flex-direction: column;
        align-items: stretch;
      }
      
      .expiry-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      .expiry-group label {
        justify-content: flex-start;
      }
      
      .expiry-group input[type="number"] {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1>DearYou üíå</h1>
        <div class="header-user">
          <span id="currentUser"></span>
          <button class="menu-btn" id="menuBtn">‚ò∞</button>
        </div>
      </div>
    </div>
    
    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel">
      <input type="text" id="searchInput" placeholder="Search messages...">
      <div class="filter-row">
        <select id="sortSelect">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
        </select>
        <select id="filterName">
          <option value="">All Users</option>
        </select>
      </div>
      <div class="filter-row">
        <select id="filterTag">
          <option value="">All Categories</option>
          <option value="Confession">Confession</option>
          <option value="Compliment">Compliment</option>
          <option value="Question">Question</option>
          <option value="Other">Other</option>
        </select>
        <button class="action-btn secondary" id="exportBtn">Export</button>
      </div>
    </div>
    
    <!-- Messages -->
    <div class="messages" id="messagesContainer">
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <h3>No messages yet</h3>
        <p>Start a conversation below</p>
      </div>
    </div>
    
    <!-- Compose -->
    <div class="compose" id="composeArea">
      <form class="compose-form" id="composeForm">
        <div class="compose-header">
          <span id="composeMode">New Message</span>
          <button type="button" id="cancelReply" style="display: none;">Cancel</button>
        </div>
        <input type="text" id="toInput" placeholder="To (name)" required>
        <select id="tagSelect">
          <option value="">Category (optional)</option>
          <option value="Confession">Confession</option>
          <option value="Compliment">Compliment</option>
          <option value="Question">Question</option>
          <option value="Other">Other</option>
        </select>
        <textarea id="messageInput" placeholder="Your message..." required></textarea>
        <div class="compose-footer">
          <div class="expiry-group">
            <label>
              <input type="checkbox" id="expiryCheck">
              Expire after
            </label>
            <input type="number" id="expiryDays" min="1" max="365" value="30" placeholder="Days" disabled>
            <span style="font-size: 13px; color: var(--text-muted);">days</span>
          </div>
          <button type="submit" class="send-btn">Send</button>
        </div>
      </form>
    </div>
    
    <!-- Compose Backdrop (Mobile Only) -->
    <div class="compose-backdrop" id="composeBackdrop"></div>
    
    <!-- Compose Toggle Button (Mobile Only) -->
    <div class="compose-toggle-wrapper" id="composeToggleWrapper">
      <div class="compose-label" id="composeLabel">Write a message</div>
      <button class="compose-toggle" id="composeToggle">‚Üë</button>
    </div>
  </div>
  
  <!-- Username Modal -->
  <div class="modal active" id="usernameModal">
    <div class="modal-content">
      <h2>Welcome to DearYou</h2>
      <p>Enter your name to start messaging. We recommend using your real name for authentic connections.</p>
      <input type="text" id="usernameInput" placeholder="Your name" maxlength="20" autofocus>
      <button id="usernameSubmit">Continue</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, push, set, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAS_hTAHk01qAVF0mSODHXB3fzUdoZ1ugI",
      authDomain: "dearyou-99de6.firebaseapp.com",
      databaseURL: "https://dearyou-99de6-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dearyou-99de6",
      storageBucket: "dearyou-99de6.firebasestorage.app",
      messagingSenderId: "783973697706",
      appId: "1:783973697706:web:50a2380766568a39ece8d3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUsername = localStorage.getItem('dearYouUsername');
    let messages = {};
    let replyingTo = null;
    
    const composeToggle = document.getElementById('composeToggle');
    const composeArea = document.getElementById('composeArea');
    const composeBackdrop = document.getElementById('composeBackdrop');
    const composeLabel = document.getElementById('composeLabel');

    // Username setup
    if (!currentUsername) {
      document.getElementById('usernameModal').classList.add('active');
    } else {
      document.getElementById('currentUser').textContent = currentUsername;
      document.getElementById('usernameModal').classList.remove('active');
    }

    document.getElementById('usernameSubmit').addEventListener('click', () => {
      const username = document.getElementById('usernameInput').value.trim();
      if (username) {
        const randomNum = Math.floor(10000 + Math.random() * 90000);
        currentUsername = `${username}#${randomNum}`;
        localStorage.setItem('dearYouUsername', currentUsername);
        document.getElementById('currentUser').textContent = currentUsername;
        document.getElementById('usernameModal').classList.remove('active');
      }
    });

    // Menu toggle
    document.getElementById('menuBtn').addEventListener('click', () => {
      document.getElementById('filterPanel').classList.toggle('active');
    });

    // Compose toggle (mobile only)
    composeToggle.addEventListener('click', () => {
      const isActive = composeArea.classList.toggle('active');
      composeBackdrop.classList.toggle('active', isActive);
      composeToggle.textContent = isActive ? '‚Üì' : '‚Üë';
      
      // Hide label after first click
      if (composeLabel && window.innerWidth <= 768) {
        composeLabel.style.display = 'none';
        localStorage.setItem('dearYouComposeHintSeen', 'true');
      }
      
      // Scroll to bottom when opening
      if (isActive) {
        setTimeout(() => {
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }, 100);
      }
    });
    
    // Check if hint was already seen
    if (localStorage.getItem('dearYouComposeHintSeen') === 'true') {
      composeLabel.style.display = 'none';
    }
    
    // Close compose area when clicking backdrop
    composeBackdrop.addEventListener('click', () => {
      composeArea.classList.remove('active');
      composeBackdrop.classList.remove('active');
      composeToggle.textContent = '‚Üë';
    });

    // Expiry checkbox
    document.getElementById('expiryCheck').addEventListener('change', (e) => {
      document.getElementById('expiryDays').disabled = !e.target.checked;
    });

    // Load messages
    onValue(ref(db, 'messages'), (snapshot) => {
      messages = snapshot.val() || {};
      renderMessages();
      updateNameFilter();
    });

    // Send message
    document.getElementById('composeForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const to = document.getElementById('toInput').value.trim();
      const message = document.getElementById('messageInput').value.trim();
      const tag = document.getElementById('tagSelect').value;
      const expiryEnabled = document.getElementById('expiryCheck').checked;
      const expiryDays = expiryEnabled ? parseInt(document.getElementById('expiryDays').value) : null;
      
      if (to && message) {
        if (replyingTo) {
          const replyRef = push(ref(db, `messages/${replyingTo}/replies`));
          set(replyRef, {
            from: currentUsername,
            message: message,
            timestamp: Date.now()
          }).catch(err => {
            console.error('Error sending reply:', err);
            alert('Failed to send reply. Please check your Firebase database rules.');
          });
          cancelReplyMode();
        } else {
          const messageData = {
            from: currentUsername,
            to: to,
            message: message,
            tag: tag,
            timestamp: Date.now(),
            reactions: {},
            replies: {},
            pinned: false,
            expiryDays: expiryDays
          };
          
          const messageRef = push(ref(db, 'messages'));
          set(messageRef, messageData).catch(err => {
            console.error('Error sending message:', err);
            alert('Failed to send message. Please check your Firebase database rules.');
          });
        }
        
        document.getElementById('toInput').value = '';
        document.getElementById('messageInput').value = '';
        document.getElementById('tagSelect').value = '';
        document.getElementById('expiryCheck').checked = false;
        document.getElementById('expiryDays').disabled = true;
        
        // Close compose area on mobile after sending
        if (window.innerWidth <= 768) {
          composeArea.classList.remove('active');
          composeBackdrop.classList.remove('active');
          composeToggle.textContent = '‚Üë';
        }
      }
    });

    document.getElementById('cancelReply').addEventListener('click', cancelReplyMode);

    function cancelReplyMode() {
      replyingTo = null;
      document.getElementById('composeMode').textContent = 'New Message';
      document.getElementById('cancelReply').style.display = 'none';
      
      // Close compose area on mobile
      if (window.innerWidth <= 768) {
        composeArea.classList.remove('active');
        composeBackdrop.classList.remove('active');
        composeToggle.textContent = '‚Üë';
      }
    }

    // Render messages
    function renderMessages() {
      const container = document.getElementById('messagesContainer');
      const search = document.getElementById('searchInput').value.toLowerCase();
      const sort = document.getElementById('sortSelect').value;
      const filterName = document.getElementById('filterName').value;
      const filterTag = document.getElementById('filterTag').value;
      const userReactions = JSON.parse(localStorage.getItem('dearYouReactions') || '{}');
      
      let messageArray = Object.entries(messages).map(([id, msg]) => ({id, ...msg}));
      
      // Auto-delete expired messages
      const now = Date.now();
      messageArray.forEach(msg => {
        if (msg.expiryDays) {
          const expiryTime = msg.timestamp + (msg.expiryDays * 24 * 60 * 60 * 1000);
          if (now > expiryTime) {
            remove(ref(db, `messages/${msg.id}`)).catch(err => {
              console.error('Error deleting expired message:', err);
            });
          }
        }
      });
      
      // Filter
      messageArray = messageArray.filter(msg => {
        const searchMatch = !search || 
          msg.message.toLowerCase().includes(search) || 
          msg.from.toLowerCase().includes(search) || 
          msg.to.toLowerCase().includes(search);
        const nameMatch = !filterName || msg.from === filterName || msg.to === filterName;
        const tagMatch = !filterTag || msg.tag === filterTag;
        return searchMatch && nameMatch && tagMatch;
      });
      
      // Sort
      messageArray.sort((a, b) => {
        return sort === 'newest' ? b.timestamp - a.timestamp : a.timestamp - b.timestamp;
      });
      
      // Separate pinned
      const pinned = messageArray.filter(m => getPinned().includes(m.id));
      const regular = messageArray.filter(m => !getPinned().includes(m.id));
      messageArray = [...pinned, ...regular];
      
      if (messageArray.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>No messages found</h3>
            <p>Try adjusting your filters</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = messageArray.map(msg => {
        const expiresIn = msg.expiryDays ? 
          Math.max(0, Math.ceil((msg.timestamp + (msg.expiryDays * 24 * 60 * 60 * 1000) - Date.now()) / (24 * 60 * 60 * 1000))) : null;
        
        return `
          <div class="message-card ${getPinned().includes(msg.id) ? 'pinned' : ''}" data-id="${msg.id}">
            <div class="message-header">
              <div class="message-meta">
                <div class="message-names">
                  <span>${msg.from}</span>
                  <span class="arrow">‚Üí</span>
                  <span>${msg.to}</span>
                </div>
                <div class="message-timestamp">${formatTimestamp(msg.timestamp)}</div>
              </div>
              ${msg.tag ? `<span class="message-tag">${msg.tag}</span>` : ''}
            </div>
            <div class="message-body">
              <div class="message-content">${msg.message}</div>
              ${expiresIn !== null ? `
                <div class="message-expires">
                  ‚è∞ Expires in ${expiresIn} day${expiresIn !== 1 ? 's' : ''}
                </div>
              ` : ''}
            </div>
            <div class="message-actions">
              <button class="action-icon ${userReactions[`${msg.id}_‚ù§Ô∏è`] ? 'active' : ''}" onclick="react('${msg.id}', '‚ù§Ô∏è')">
                ‚ù§Ô∏è <span class="reaction-count">${msg.reactions?.['‚ù§Ô∏è'] || 0}</span>
              </button>
              <button class="action-icon ${userReactions[`${msg.id}_üëç`] ? 'active' : ''}" onclick="react('${msg.id}', 'üëç')">
                üëç <span class="reaction-count">${msg.reactions?.['üëç'] || 0}</span>
              </button>
              <button class="action-icon ${userReactions[`${msg.id}_üòä`] ? 'active' : ''}" onclick="react('${msg.id}', 'üòä')">
                üòä <span class="reaction-count">${msg.reactions?.['üòä'] || 0}</span>
              </button>
              <button class="action-icon" onclick="reply('${msg.id}')">‚Ü©Ô∏è</button>
              <button class="action-icon ${getPinned().includes(msg.id) ? 'active' : ''}" onclick="togglePin('${msg.id}')">
                ${getPinned().includes(msg.id) ? 'üìå' : 'üìç'}
              </button>
            </div>
            ${msg.replies && Object.keys(msg.replies).length > 0 ? `
              <div class="replies">
                ${Object.values(msg.replies).map(r => `
                  <div class="reply-item">
                    <div class="reply-header">${r.from} ¬∑ ${formatTimestamp(r.timestamp)}</div>
                    <div class="reply-content">${r.message}</div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Reactions
    window.react = (messageId, emoji) => {
      const userReactions = JSON.parse(localStorage.getItem('dearYouReactions') || '{}');
      const reactionKey = `${messageId}_${emoji}`;
      const currentCount = messages[messageId]?.reactions?.[emoji] || 0;
      
      // Check if user already reacted with this emoji
      if (userReactions[reactionKey]) {
        // Remove reaction
        update(ref(db, `messages/${messageId}`), {
          [`reactions/${emoji}`]: Math.max(0, currentCount - 1)
        }).catch(err => {
          console.error('Error removing reaction:', err);
        });
        delete userReactions[reactionKey];
      } else {
        // Add reaction
        update(ref(db, `messages/${messageId}`), {
          [`reactions/${emoji}`]: currentCount + 1
        }).catch(err => {
          console.error('Error adding reaction:', err);
        });
        userReactions[reactionKey] = true;
      }
      
      localStorage.setItem('dearYouReactions', JSON.stringify(userReactions));
    };

    // Reply
    window.reply = (messageId) => {
      replyingTo = messageId;
      const msg = messages[messageId];
      document.getElementById('composeMode').textContent = `Reply to ${msg.from}`;
      document.getElementById('cancelReply').style.display = 'block';
      document.getElementById('toInput').value = msg.from;
      document.getElementById('messageInput').focus();
      
      // Open compose area on mobile
      if (window.innerWidth <= 768) {
        composeArea.classList.add('active');
        composeBackdrop.classList.add('active');
        composeToggle.textContent = '‚Üì';
      }
      
      window.scrollTo(0, document.body.scrollHeight);
    };

    // Pin messages
    function getPinned() {
      return JSON.parse(localStorage.getItem('pinnedMessages') || '[]');
    }

    window.togglePin = (messageId) => {
      let pinned = getPinned();
      if (pinned.includes(messageId)) {
        pinned = pinned.filter(id => id !== messageId);
      } else {
        pinned.push(messageId);
      }
      localStorage.setItem('pinnedMessages', JSON.stringify(pinned));
      renderMessages();
    };

    // Export
    document.getElementById('exportBtn').addEventListener('click', () => {
      let text = 'DearYou Messages Export\n';
      text += '‚ïê'.repeat(50) + '\n\n';
      
      Object.values(messages).forEach(msg => {
        text += `From: ${msg.from}\n`;
        text += `To: ${msg.to}\n`;
        if (msg.tag) text += `Category: ${msg.tag}\n`;
        text += `Date: ${new Date(msg.timestamp).toLocaleString()}\n`;
        text += `\n${msg.message}\n`;
        
        if (msg.replies && Object.keys(msg.replies).length > 0) {
          text += '\nReplies:\n';
          Object.values(msg.replies).forEach(r => {
            text += `  ${r.from} (${new Date(r.timestamp).toLocaleString()}):\n  ${r.message}\n`;
          });
        }
        text += '\n' + '‚îÄ'.repeat(50) + '\n\n';
      });
      
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dearyou-export-${Date.now()}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Update filters
    function updateNameFilter() {
      const nameSet = new Set();
      Object.values(messages).forEach(msg => {
        nameSet.add(msg.from);
        nameSet.add(msg.to);
      });
      
      const select = document.getElementById('filterName');
      const current = select.value;
      select.innerHTML = '<option value="">All Users</option>';
      Array.from(nameSet).sort().forEach(name => {
        select.innerHTML += `<option value="${name}">${name}</option>`;
      });
      select.value = current;
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', renderMessages);
    document.getElementById('sortSelect').addEventListener('change', renderMessages);
    document.getElementById('filterName').addEventListener('change', renderMessages);
    document.getElementById('filterTag').addEventListener('change', renderMessages);
  </script>
</body>
</html>
